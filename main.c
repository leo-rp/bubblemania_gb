#include <gb/gb.h>
#include <string.h>
#include <stdio.h>

#include "face.c"
#include "map.c"
#include "maptiles.c"
#include "carillon_funcs.c"


#define GAME_BOOT 0X00
#define GAME_INTRO 0X01
#define GAME_TITLE 0X02
#define GAME_PLAY  0X03
#define GAME_PAUSE 0X04
#define GAME_OVER  0X05


#define mapSize 0x16
#define SOLID 0x3F
#define IS_SOLID(x) (x > SOLID ) ? TRUE : FALSE
#define maximo(a,b) (a > b) ? a : b


#define CLICKED(x) ((joystate & x) && (joystate & x) != (oldjoystate & x))
#define RELEASED(x) (!(joystate & x) && (joystate & x) != (oldjoystate & x))
#define ISDOWN(x) (joystate & (x))


const UINT8 fadePals[] = {
	0xE4, // 11100100
	0x90, // 10010000
	0x40, // 01000000
	0x00  // 00000000
};


// ////////////////
// //            //
// //  Map Data  //
// //            //
// ////////////////

const unsigned char logo_map_data[] ={
  0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x04,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x00,0x05,0x06,0x06,0x07,
  0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x08,0x09,
  0x0A,0x01,0x01,0x0B,0x0C,0x0D,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x01,0x01,0x01,0x01,0x01,0x0E,0x0F,0x04,0x04,0x04,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x10,0x11,0x01,0x12,0x13,0x13,0x13,0x14,0x14,0x14,0x15,0x04,0x16,
  0x17,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x01,0x01,0x02,0x19,0x1A,0x00,0x00,0x1B,
  0x1C,0x03,0x04,0x1D,0x1E,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x20,0x01,0x02,0x21,
  0x22,0x00,0x00,0x23,0x24,0x03,0x04,0x25,0x26,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x01,0x27,0x28,0x28,0x28,0x28,0x28,0x28,0x29,0x2A,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x01,0x2B,0x04,0x04,0x04,0x04,0x04,0x04,0x2C,0x1D,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x01,0x01,0x01,0x2D,0x04,0x04,0x04,0x04,
  0x2E,0x1D,0x1D,0x1D,0x1E,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x01,0x01,0x01,0x2D,
  0x04,0x04,0x04,0x2F,0x30,0x1D,0x1D,0x1D,0x1E,0x00,0x00,0x00,0x00,0x00,0x31,0x0A,
  0x01,0x01,0x01,0x2D,0x04,0x04,0x04,0x32,0x1D,0x1D,0x1D,0x1D,0x1E,0x00,0x00,0x00,
  0x00,0x33,0x34,0x01,0x01,0x01,0x01,0x2D,0x04,0x04,0x04,0x32,0x1D,0x1D,0x1D,0x1D,
  0x35,0x36,0x37,0x00,0x11,0x38,0x01,0x01,0x01,0x01,0x39,0x3A,0x04,0x04,0x3B,0x3C,
  0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,0x3D,0x16,0x01,0x01,0x01,0x01,0x01,0x01,0x2B,0x04,
  0x3E,0x3F,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,0x01,0x01,0x01,0x01,
  0x01,0x40,0x41,0x04,0x2C,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,
  0x01,0x01,0x01,0x42,0x43,0x04,0x04,0x44,0x45,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,
  0x1D,0x1D,0x1D,0x1D,0x01,0x01,0x01,0x46,0x04,0x04,0x04,0x2E,0x1D,0x1D,0x1D,0x1D,
  0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D,0x1D
};

// /////////////////
// //             //
// //  Tile Data  //
// //             //
// /////////////////

const unsigned char logo_tile_data[] ={
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,
  0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,
  0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0x00,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,
  0x00,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,
  0x00,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,
  0xC0,0x00,0xC0,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,
  0x00,0x00,0x00,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,
  0x03,0x00,0x03,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,
  0xC0,0x00,0xC0,0x00,0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,
  0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0x00,0x03,0x00,0x03,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0xFF,0x00,0xFF,0x00,0xFF,0x00,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,
  0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,
  0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,
  0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x00,0x0F,0x00,0x0F,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0x00,0xFC,0x00,0xFC,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0x00,0x3F,0x00,0x3F,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x00,0xF0,0x00,0xF0,0x00,
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,
  0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x00,0x00,0x00,0x00,
  0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0x00,0x00,0x00,0x00,
  0x0F,0x00,0x0F,0x00,0x0F,0x00,0x0F,0x00,0x0F,0x00,0x0F,0x00,0x00,0x00,0x00,0x00,
  0xFC,0x00,0xFC,0x00,0xFC,0x00,0xFC,0x00,0xFC,0x00,0xFC,0x00,0x00,0x00,0x00,0x00,
  0x3F,0x00,0x3F,0x00,0x3F,0x00,0x3F,0x00,0x3F,0x00,0x3F,0x00,0x00,0x00,0x00,0x00,
  0xF0,0x00,0xF0,0x00,0xF0,0x00,0xF0,0x00,0xF0,0x00,0xF0,0x00,0x00,0x00,0x00,0x00,
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,
  0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0x00,0x00,
  0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x00,0xC0,0x3F,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,
  0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x00,0x03,0x03,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xFF,0xFF,
  0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,
  0x03,0xFF,0x03,0xFF,0x03,0xFF,0x03,0xFF,0x03,0xFF,0x03,0xFF,0x03,0xFF,0x03,0xFF,
  0xF0,0x0F,0xF0,0x0F,0xF0,0x0F,0xF0,0x0F,0xF0,0x0F,0xF0,0x0F,0xF0,0x0F,0xF0,0x0F,
  0x0F,0xFF,0x0F,0xFF,0x0F,0xFF,0x0F,0xFF,0x0F,0xFF,0x0F,0xFF,0x0F,0xFF,0x0F,0xFF,
  0x00,0xFF,0x3F,0xFF,0x3F,0xFF,0x3F,0xFF,0x3F,0xFF,0x3F,0xFF,0x3F,0xFF,0x3F,0xFF,
  0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0x00,0x00,0x00,0x00,0x0F,0x00,0x0F,0x00,0x0F,0x00,0x0F,0x00,0x0F,0x00,0x0F,0x00,
  0x3F,0xFF,0x3F,0xFF,0x3F,0xFF,0x3F,0xFF,0x3F,0xFF,0x3F,0xFF,0x3F,0xFF,0x3F,0xFF,
  0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0x00,0x3F,0x00,0x3F,0x00,0x3F,0x00,0x3F,0x00,
  0x0F,0x00,0x0F,0x00,0x0F,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,
  0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,
  0x3F,0x00,0x3F,0x00,0x3F,0x00,0x3F,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,
  0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,
  0xF0,0x0F,0xF0,0x0F,0xF0,0x0F,0xF0,0x0F,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0x3F,0xFF,0x3F,0xFF,0x3F,0xFF,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x03,0xFF,0x03,0xFF,0x03,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0x00,0xFF,0x00,0xFF,
  0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,0xC0,0x3F,0x00,0xFF,0x00,0xFF,
  0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFC,0x03,
  0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0x00,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x0F,0xFF,
  0x03,0xFF,0x03,0xFF,0x03,0xFF,0x03,0xFF,0x03,0xFF,0x03,0xFF,0x03,0xFF,0xFF,0xFF,
  0xFC,0x03,0xFC,0x03,0xFC,0x03,0xFC,0x03,0xFC,0x03,0xFC,0x03,0xFC,0x03,0xFC,0x03
};



// ////////////////
// //            //
// //  Map Data  //
// //            //
// ////////////////

const unsigned char title_map_data[] ={
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x02,0x03,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x04,0x05,0x06,0x07,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x08,0x09,0x0A,0x0B,0x0C,0x0D,0x0E,0x0F,0x10,0x11,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x12,0x13,0x14,0x15,0x16,0x17,0x18,0x19,
  0x01,0x1A,0x1B,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x1C,0x1D,0x1E,0x01,
  0x1F,0x01,0x01,0x01,0x20,0x21,0x22,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x23,0x24,0x25,0x26,0x01,0x27,0x28,0x29,0x2A,0x2B,0x2C,0x01,0x01,0x01,0x01,0x01,
  0x01,0x01,0x01,0x01,0x01,0x2D,0x2E,0x2F,0x30,0x31,0x32,0x33,0x34,0x35,0x36,0x01,
  0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x37,0x38,0x39,0x3A,0x3B,0x3C,
  0x3D,0x3E,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
  0x3F,0x01,0x40,0x41,0x42,0x01,0x01,0x01
};

// /////////////////
// //             //
// //  Tile Data  //
// //             //
// /////////////////

const unsigned char title_tile_data[] ={
  0xFF,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0x00,0xFF,0x01,0xFF,0x01,0xFF,0x01,0xFF,0x03,0xFF,0x03,0xFF,0x03,0xFF,0x1F,0xFF,
  0x7A,0xFF,0xFC,0xFF,0xF8,0xFF,0xFC,0xFF,0xFC,0xFF,0xF0,0xFF,0xE0,0xFF,0xF8,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFE,0x00,0xF0,0x00,0x80,0x00,0xE0,
  0x3E,0xFE,0x10,0xF0,0x60,0xE0,0x78,0x78,0x00,0x00,0x01,0x01,0x01,0x01,0x00,0x00,
  0x3C,0x3F,0x3E,0x3F,0x7E,0x7F,0x7F,0x7F,0x3F,0x3F,0xFF,0xFF,0xFE,0xFF,0xFF,0xFF,
  0x00,0xFF,0x00,0xFF,0x80,0xFF,0xC0,0xFF,0xC0,0xFF,0xC0,0xFF,0x00,0xFF,0x00,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x03,0xFF,0x01,0xFF,0x00,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xD0,0xFF,0x78,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x01,0xFF,0x01,0xFF,0x01,0x7F,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xC0,0xFF,
  0x00,0xFF,0x01,0xFF,0x03,0xFF,0x01,0xFF,0x03,0xFF,0x03,0xFF,0x0C,0xFC,0x06,0xFE,
  0x00,0xFF,0x80,0xFF,0xC0,0xF0,0xC0,0xF0,0xE0,0xF0,0x00,0x00,0x00,0x00,0xFC,0xFC,
  0x00,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01,
  0x03,0x03,0x03,0x03,0x01,0x01,0x09,0x09,0x3F,0x3F,0x3F,0x3F,0x3F,0x3F,0xFF,0xFF,
  0xFF,0xFF,0xFF,0xFF,0xFE,0xFF,0xFF,0xFF,0xFE,0xFF,0xFC,0xFF,0xFE,0xFF,0xFE,0xFF,
  0xC0,0xFF,0x00,0xFF,0x00,0xFF,0x80,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0x48,0xCC,0x60,0xE0,0x60,0xE0,0x70,0xF0,0x7C,0xFC,0x3F,0xFF,0x0F,0xFF,0x0F,0xFF,
  0x00,0x37,0x00,0x02,0x00,0x00,0x00,0x00,0x01,0x01,0x81,0x81,0xBF,0xBF,0xFF,0xFF,
  0xF8,0xFF,0x18,0x1F,0x18,0x1F,0xF0,0xFF,0xF3,0xFF,0xC3,0xFF,0xE1,0xFF,0x81,0xFF,
  0x07,0xFF,0x01,0xFF,0x00,0xFF,0x0E,0xFF,0x0E,0xFF,0x07,0xFF,0x87,0xFF,0x87,0xFF,
  0xFF,0xFF,0xFF,0xFF,0x1F,0xFF,0x0F,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xE0,0xFF,
  0x3F,0x3F,0xFF,0xFF,0xFF,0xFF,0xCF,0xFF,0x07,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0xFF,0xFF,0xFC,0xFF,0xFE,0xFF,0xFC,0xFF,0xE0,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0xF0,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x03,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x80,0xFF,
  0x07,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x04,0xFF,
  0xFC,0xFF,0x3E,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0x01,0xFF,0x03,0xFF,0x03,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0x70,0xFF,0x70,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x1F,0xFF,0x1F,0xFF,0x0F,0xFF,
  0xFF,0xFF,0x7F,0xFF,0x7F,0xFF,0x3F,0xFF,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0xC0,0xFF,0xE0,0xFF,0xE0,0xFF,0xFC,0xFF,0x80,0xFF,0xC0,0xFF,0xE0,0xFF,0xF8,0xFF,
  0x1E,0xFF,0x07,0xFF,0x07,0xFF,0x03,0xFF,0x01,0xFF,0x01,0xFF,0x01,0xFF,0x01,0xFF,
  0x00,0xFF,0xC0,0xFF,0xC0,0xFF,0xC0,0xFF,0xFC,0xFF,0xFC,0xFF,0xFC,0xFF,0x84,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x60,0xFF,0x60,0xFF,0x60,0xFF,0x60,0xFF,0x70,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x38,0xFF,0x18,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xE0,0xFF,0xF0,0xFF,
  0x00,0xFF,0x00,0xFF,0x3C,0xFF,0x1E,0xFF,0x1F,0xFF,0x0F,0xFF,0x0F,0xFF,0x07,0xFF,
  0x00,0xFF,0x07,0xFF,0x03,0xFF,0x03,0xFF,0x01,0xFF,0x01,0xFF,0x80,0xFF,0x80,0xFF,
  0x0F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x78,0xFF,0x3C,0xFF,
  0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x03,0xFF,0x01,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x80,0xFF,0xC0,0xFF,0xF0,0xFF,0xF8,0xFF,0xF8,0xFF,
  0x0F,0xFF,0x07,0xFF,0x07,0xFF,0x01,0xFF,0x01,0xFF,0x01,0xFF,0x00,0xFF,0x00,0xFF,
  0xFE,0xFF,0xFE,0xFF,0xFE,0xFF,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC1,0xFF,
  0x18,0xFF,0x18,0xFF,0x18,0xFF,0x0E,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0xFC,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0xF0,0xFF,0x78,0xFF,0x78,0xFF,0x3C,0xFF,0x3C,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0x07,0xFF,0x3F,0xFF,0x0F,0xFF,0x07,0xFF,0x07,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0xC0,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
  0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC,0xFF,0xFF,0xFF,
  0x01,0xFF,0x00,0xFF,0x80,0xFF,0xC0,0xFF,0xC0,0xFF,0xE0,0xFF,0x00,0xFF,0x00,0xFF,
  0xFC,0xFF,0xFE,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0x43,0xFF,0x01,0xFF,0x01,0xFF,0x01,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0xFF,0xFF,0xFF,0xFF,0xC3,0xFF,0xC1,0xFF,0xC1,0xFF,0x61,0xFF,0x00,0xFF,0x00,0xFF,
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0xFF,0xC0,0xFF,0xC0,0xFF,0xC0,0xFF,0xC0,0xFF,
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0xFF,0x03,0xFF,0x01,0xFF,0x01,0xFF,0x00,0xFF,
  0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xE0,0xFF,0xE0,0xFF,0xF0,0xFF,
  0xFF,0xFF,0xFF,0xFF,0xF0,0xFF,0xF8,0xFF,0xF8,0xFF,0x3C,0xFF,0x1C,0xFF,0x1E,0xFF,
  0xFF,0xFF,0xFF,0xFF,0x7F,0xFF,0x07,0xFF,0x03,0xFF,0x03,0xFF,0x01,0xFF,0x00,0xFF,
  0x80,0xFF,0xC0,0xFF,0xC0,0xFF,0xE0,0xFF,0xE0,0xFF,0xF0,0xFF,0xF0,0xFF,0x18,0xFF,
  0x70,0xFF,0x60,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0xF0,0xFF,0x78,0xFF,0x78,0xFF,0x3C,0xFF,0x3C,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0x0E,0xFF,0x0F,0xFF,0x07,0xFF,0x01,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,
  0x00,0xFF,0x00,0xFF,0x00,0xFF,0x80,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF,0x00,0xFF
};


INT8 game_status;
INT16 xpos, ypos; 
INT8 ysp, xsp, gravity, jump_force, shoot_force, speed_movement, player_direction, animate, soffset;
INT16 sensor_a, sensor_b;


UINT8 sflip, sindex, lshoot, rshoot, dshoot;
UINT8 onGround, can_jump;
UINT8 stepCounter = 0;
UBYTE oldjoystate, joystate;
UINT8 i;
INT16 index, index2;

UBYTE ix, iy, counter, offset, win;
UINT16 p1, p2;



void LCD_Interrupt(void){

	
	/*
	
	
	if(LY_REG < 120u) {
		
		SCX_REG = 0x00;
	}else{
		
		SCX_REG = effect[counter];		
		
		if(counter != 64u){
			
			counter+=1;
		}else{
			counter = 0;
		}
		
		
	}
	
	//SCX_REG = 0x00;
	
*/
}

void fade(){
	
	for(i = 0x00; i < 0x04; i+= 0x01 ){
		BGP_REG = fadePals[i];
		i+=0x01;
	}
}


INT16 map_down_collision(INT16 x, INT16 y){
	INT16 a, b, x2;
	
	x2 = x + 0x06;
	x = x - 0x06;
	x = x >> 3;
	x2 = x2 >> 3;
	
	y = y + 0x0D;
	y = y >> 3;
			
	index = ((mapSize * y) + x);
	a = map[index];
	index2 = ((mapSize * y) + x2);
	b = map[index2];
	
	if( IS_SOLID(a) || IS_SOLID(b)){
		return 1;
	}else{
		return 0;
	}
}

INT16 map_collision(INT16 x, INT16 y, UINT8 dir){
	INT16 a, b; 
	x = x - 0x08;
	switch (dir) {
		case 0x08:
			y = y - 0x0D;
		break;
		
		case 0x06: //right
			//x-= 0x01;
			//x+= xsp;
			b = 0x02;
			a = 0x02;
			
		break;
		
		case 0x02: //down
		break;
		
		
		case 0x04: //left			
			//x-= xsp;
			a = 0x00;
			b = 0x00;
			
		break;
	}
	
	
	x = x >> 3;
	y = y >> 3;
	
	
	index = ((mapSize * y) + x);
	
	
	a = map[index + a];
	b = map[(index + b) +  mapSize];
	
	if( IS_SOLID(a) || IS_SOLID(b)  ){
		return 1;
	}else{
		return 0;
	}
}

void fx_jump(){
	NR10_REG = 0x77;
	NR11_REG = 0x41;
	NR12_REG = 0x82;
	NR13_REG = 0xC2;
	NR14_REG = 0xC6;
}

void draw_player(){	
	
	if(sflip){
		set_sprite_tile(2, sindex);
		set_sprite_tile(3, sindex + 0x01);	
		set_sprite_tile(0, sindex + 0x02);
		set_sprite_tile(1, sindex + 0x03);		
	}else{	
		set_sprite_tile(0, sindex);
		set_sprite_tile(1, sindex + 0x01);	
		set_sprite_tile(2, sindex + 0x02);
		set_sprite_tile(3, sindex + 0x03);
	}
	set_sprite_prop(0, sflip);
	set_sprite_prop(1, sflip);
	set_sprite_prop(2, sflip);
	set_sprite_prop(3, sflip);
}


void checkInput() {
	oldjoystate = joystate;
	joystate = joypad();
	//sflip = 0x00;
	player_direction = 0x00;
	///sindex = 0x00;
	sflip = 0x00;
	sindex = soffset;
		
	
	if(joypad()){
		
		if (joypad() & J_UP){						
			sindex = 0x20;
			//player_direction = 0x08;
		}
		 
		if (joypad() & J_DOWN){								
			sindex+= 0X18;		
			player_direction = 0x02;
		}
		
			
	
		if (joypad() & J_LEFT){			
			sflip= 0x20;
			player_direction = 0x04;
			sindex+= 0x10;	
		}
	
		if (joypad() & J_RIGHT){			
				sflip+= 0x00;
				player_direction = 0x06;
				sindex+= 0X10;
			
			
			/*if(xpos != 0x98){				
				if(!map_collision(xpos, ypos, 0x02)){
					xpos+= speed_movement;
				}
			}*/
		}
	
		if (joypad() & J_START){
	     /* printf("..X%u Y%u \n", (INT16)xpos, (INT16)ypos );			 
		 printf("Index:%u Index2:%u \n", (INT16)index, (INT16)index2 );*/		  
		}
			
		if(RELEASED(J_A)){
			//can_jump = 0x01;
		}
		
		
		if (ISDOWN(J_A)){
			
			if(player_direction == 0x02){
				if(ypos != 0x18){
					if( ysp == 0x00){
						rshoot = 0x01;
						lshoot = 0x00;
						dshoot = 0x01;
						ysp = jump_force;
						fx_jump();
					}
				}
			}
			
			if(player_direction == 0x06){
				if(xpos != 0x10){
					if( xsp == 0x00){
						rshoot = 0x01;
						lshoot = 0x00;
						dshoot = 0x00;
						xsp = shoot_force;
						fx_jump();						
					}				
					
				}			
			}
			
			if(player_direction == 0x04){
				if(xpos != 0x98){
					if( xsp == 0x00){						
							lshoot = 0x01;
							rshoot = 0x00;
							dshoot = 0x00;
							xsp = shoot_force;
							fx_jump();
						
					}				
					
				}			
			}
		} 		
		
		
	}else{
		if(onGround){
			
			draw_player();
			
		}
		
	}	
}
	

void game_play(){
	if(stepCounter > 0x00){			
		stepCounter = 0x00;
		
		animate+= 0x01;
		if(animate > 0x08){			
			soffset = 0x04;
			
			
			memcpy(0x91E0, 0x91F0, sizeof(unsigned char) * 16);
			memcpy(0x9210, 0x9220, sizeof(unsigned char) * 16);
			
		}else{
			//animate = 0x00;
			soffset = 0x00;
			memcpy(0x91E0, 0x9200, sizeof(unsigned char) * 16);
			memcpy(0x9210, 0x9230, sizeof(unsigned char) * 16);
		}
		if(animate == 0x0f){
			animate = 0x00;
		}
		
		
		checkInput();
		onGround = map_down_collision(xpos, ypos);
		if (ypos > 0x8F){
			ypos = 0x10;
		}
			
		
		
		if(ysp != 0x00){
			 ysp-= 0x01;
		}
		
		if(xsp != 0x00){
			 xsp-= 0x01;
		}
		
		if(dshoot){
			if( ypos > 0x17){
				ypos-= ysp;
			}
		}
		
		
		if(lshoot){
			if(map_collision(xpos, ypos, 0x06)){
				xsp = 0x00;
			}else{
				xpos+= xsp;							
			}
		}
			
		if(rshoot){
			if(map_collision(xpos, ypos, 0x04)){
				xsp = 0x00;
			}else{
				xpos-= xsp;							
			}
		}
				
		
		
		
		
		
		
		if(onGround){
			//ysp = 0x00;
			//can_jump = 0x00;
			//ypos-=gravity;			
		}else{
			ypos+= gravity;
			
		}

		draw_player();
		move_sprite(0, xpos - 0x08, ypos);
		move_sprite(1, xpos - 0x08, ypos + 0x08);
		move_sprite(2, xpos, ypos );
		move_sprite(3, xpos, ypos + 0x08);

		
			
			
				
		
			
	}else{			
		stepCounter+= 0x01;
	}
}



void game_boot() {
    //memcpy(&col_mapxy, &map, sizeof(unsigned char) * 360);
	
	HIDE_SPRITES;
	HIDE_WIN;
    HIDE_BKG;
    STAT_REG = 8;
    
    //disable_interrupts();
    //add_LCD(LCD_Interrupt);
	//add_VBL(VBL_Interrupt);
    //enable_interrupts();
    
   
	
	/*if((_cpu == 0x01 )  || (_cpu == 0xFF)){
	  BGP_REG = 0x01B; //classic and pocket	
	}*/
	
    

	
	gravity = 0x03;
	jump_force = 0x0A;
	shoot_force = 0x04;
	speed_movement = 0x02;
    xpos = 0x58;
    ypos = 0x10;
	ysp = 0x00;
	xsp = 0x00;
	sflip = 0x00;
	can_jump = 0x01;
	
	
	//bank, sample,song
	CP_LoadMusic(2, 0, 0 );
	
	//set_interrupts(LCD_IFLAG | VBL_IFLAG );
    
    SHOW_BKG;
    //SHOW_WIN;
	SHOW_SPRITES;
	draw_player(0x00);
}

void game_intro(){
	set_bkg_data(0, 0x47, logo_tile_data);
    set_bkg_tiles(0, 0, 20, 18, logo_map_data);
	delay(1500);
	game_status = GAME_TITLE;
}

game_title(){
	set_bkg_data(0, 0x43, title_tile_data);
    set_bkg_tiles(0, 0, 20, 18, title_map_data);  
	if(joypad()){
		set_bkg_data(0, 127, maptiles);
		set_bkg_tiles(0, 0, 22, 21, map);    
		set_sprite_data(0, 40, face);
		SCX_REG = 0x08;
		SCY_REG = 0x0F;
		CP_Play();	
		game_status = GAME_PLAY;
	}


}

void main() {
    game_status = GAME_BOOT;
	
	while (1) {		
		wait_vbl_done();
		
			
		switch (game_status){
			case GAME_BOOT:
				game_boot();				
				
				game_status = GAME_INTRO;			
			break;
			
			case GAME_INTRO:
				//game intro
				game_intro();
			break;
			
			case GAME_TITLE:
				game_title();
				//game_status = GAME_PLAY;			
			break;
			
			case GAME_PLAY:				
				game_play();
				CP_UpdateMusic();
				
			break;
			
			case GAME_PAUSE:
				//game PAUSE
			break;
			
			case GAME_OVER:
				//game OVER
			break;
		}	
	
	
    }

}
